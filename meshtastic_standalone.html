<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Standalone Meshtastic Command Center - Works completely offline">
    <meta name="theme-color" content="#0a0e17">
    
    <title>Meshtastic Command Center - Standalone</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVzaHRhc3RpYyBDb21tYW5kIENlbnRlciIsInNob3J0X25hbWUiOiJNZXNoQ29tbWFuZCIsInN0YXJ0X3VybCI6Ii4vaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYTBlMTciLCJ0aGVtZV9jb2xvciI6IiMwMGQ5ZmYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0Xwn5OhJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjUxMng1MTIifV19">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e17;
            --bg-darker: #050810;
            --bg-card: #0f1419;
            --bg-elevated: #1a1f2e;
            --accent-cyan: #00d9ff;
            --accent-magenta: #ff006e;
            --accent-yellow: #ffbe0b;
            --accent-green: #06ffa5;
            --accent-blue: #3b82f6;
            --text-primary: #e8eaed;
            --text-secondary: #9ba3af;
            --text-dim: #64748b;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 110, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.online { background: var(--accent-green); }
        .status-dot.offline { background: var(--text-dim); }
        .status-dot.connecting { background: var(--accent-yellow); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Main Layout */
        main {
            flex: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Card Styles */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        /* Map Container */
        #map-container {
            grid-column: 1 / -1;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            filter: brightness(0.9) contrast(1.1) saturate(1.2);
        }

        .map-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 1000;
            font-size: 0.85rem;
        }

        /* Button Styles */
        .btn {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
        }

        .btn-secondary:not(:disabled):hover {
            border-color: var(--accent-green);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Connection Panel */
        .connection-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .connection-btn {
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connection-btn:hover:not(.disabled) {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .connection-btn.active {
            border-color: var(--accent-green);
            background: rgba(6, 255, 165, 0.1);
        }

        .connection-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .connection-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .connection-label {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Node List */
        .node-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .node-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node-item:hover {
            border-color: var(--accent-cyan);
            transform: translateX(4px);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .node-name {
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .node-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            color: var(--text-dim);
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .metric-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .metric-value.good { color: var(--accent-green); }
        .metric-value.warning { color: var(--accent-yellow); }
        .metric-value.bad { color: var(--accent-magenta); }

        /* Message Log */
        .message-log {
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border-left: 3px solid var(--accent-cyan);
            border-radius: 4px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        /* Input Fields */
        input, textarea, select {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: var(--bg-elevated);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-darker);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        /* Offline Indicator */
        .offline-banner {
            background: var(--accent-yellow);
            color: var(--bg-dark);
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .offline-banner.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.25rem;
            }

            .status-bar {
                font-size: 0.75rem;
            }

            #map-container {
                height: 300px;
            }

            .connection-methods {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Install Prompt */
        .install-prompt {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="offline-banner" id="offline-banner">
        ‚ö†Ô∏è You are offline - Using cached data
    </div>

    <div class="app-container">
        <header>
            <div class="header-content">
                <h1>‚ö° MESH_COMMAND</h1>
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-dot offline" id="connection-dot"></span>
                        <span id="connection-status">Not Connected</span>
                    </div>
                    <div class="status-item">
                        <span>Nodes: <strong id="node-count">0</strong></span>
                    </div>
                    <div class="status-item">
                        <span>Messages: <strong id="message-count">0</strong></span>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <!-- Install Prompt -->
            <div class="install-prompt" id="install-prompt">
                <h3 style="margin-bottom: 0.5rem;">üì± Install this app for offline use</h3>
                <p style="margin-bottom: 1rem; opacity: 0.9;">Works completely offline - no internet required!</p>
                <button class="btn btn-secondary" onclick="installApp()">Install Now</button>
            </div>

            <!-- Connection Panel -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Connection Methods</h3>
                </div>
                
                <div class="connection-methods">
                    <div class="connection-btn" id="bluetooth-btn" onclick="connectBluetooth()">
                        <div class="connection-icon">üì°</div>
                        <div class="connection-label">Bluetooth</div>
                        <div class="connection-status" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-dim);">Web Bluetooth</div>
                    </div>
                    
                    <div class="connection-btn" id="wifi-btn" onclick="connectWiFi()">
                        <div class="connection-icon">üì∂</div>
                        <div class="connection-label">WiFi</div>
                        <div class="connection-status" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-dim);">Network API</div>
                    </div>
                    
                    <div class="connection-btn" id="serial-btn" onclick="connectSerial()">
                        <div class="connection-icon">üîå</div>
                        <div class="connection-label">USB Serial</div>
                        <div class="connection-status" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-dim);">Web Serial</div>
                    </div>
                    
                    <div class="connection-btn disabled" id="gsm-btn">
                        <div class="connection-icon">üìû</div>
                        <div class="connection-label">GSM</div>
                        <div class="connection-status" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-dim);">Coming Soon</div>
                    </div>
                </div>

                <div id="connection-details" style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; display: none;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        <strong id="connection-method-name"></strong>
                        <div id="connection-info" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard">
                <!-- Map -->
                <div class="card" id="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <div>üìç Network Coverage</div>
                        <div id="coverage-info" style="margin-top: 0.5rem; color: var(--text-dim);">
                            No nodes discovered
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Network Stats</h3>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-nodes">0</div>
                            <div class="stat-label">Nodes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-messages">0</div>
                            <div class="stat-label">Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-snr">--</div>
                            <div class="stat-label">Avg SNR</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-range">--</div>
                            <div class="stat-label">Range</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn" onclick="startDiscovery()" id="discover-btn">
                            üîç Start Discovery
                        </button>
                        <button class="btn btn-secondary" onclick="openBroadcastModal()">
                            üì¢ Send Broadcast
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            üíæ Export Data
                        </button>
                    </div>
                </div>

                <!-- Discovered Nodes -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3 class="card-title">Discovered Nodes</h3>
                        <span id="last-update" style="font-size: 0.75rem; color: var(--text-dim);"></span>
                    </div>
                    <div class="node-list" id="node-list">
                        <div style="text-align: center; padding: 2rem; color: var(--text-dim);">
                            Connect to a Meshtastic device to discover nodes
                        </div>
                    </div>
                </div>

                <!-- Message Log -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3 class="card-title">Message Log</h3>
                        <button class="btn btn-secondary btn-small" onclick="clearMessages()">Clear</button>
                    </div>
                    <div class="message-log" id="message-log">
                        <div class="message">
                            <div class="message-header">
                                <span>System</span>
                                <span id="init-time"></span>
                            </div>
                            <div class="message-body">üöÄ Standalone Meshtastic Command Center initialized - Works completely offline!</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Broadcast Modal -->
    <div class="modal" id="broadcast-modal">
        <div class="modal-content">
            <div class="card-header">
                <h3 class="card-title">Send Broadcast Message</h3>
            </div>
            <div class="form-group">
                <label>Message</label>
                <textarea id="broadcast-message" placeholder="Enter your message..."></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="message-priority">
                    <option value="normal">Normal</option>
                    <option value="high">High Priority</option>
                    <option value="emergency">Emergency</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <button class="btn" onclick="sendBroadcast()">Send</button>
                <button class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // =================================================================
        // STANDALONE MESHTASTIC COMMAND CENTER
        // Works completely offline with Web Bluetooth, Web Serial, WiFi
        // No backend server required!
        // =================================================================

        let map;
        let markers = {};
        let nodes = new Map();
        let messageCount = 0;
        let startTime = Date.now();
        let currentConnection = null;
        let connectionType = null;
        let deferredPrompt = null;

        // Connection interfaces
        let bluetoothDevice = null;
        let serialPort = null;
        let wifiSocket = null;

        // =================================================================
        // INITIALIZATION
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            checkBrowserSupport();
            loadCachedData();
            setupOfflineDetection();
            setupPWA();
            document.getElementById('init-time').textContent = new Date().toLocaleTimeString();
            
            addMessage('System', '‚úì Ready to connect via Bluetooth, WiFi, or Serial');
            addMessage('System', 'üì± This app works completely offline - no internet required!');
        });

        // =================================================================
        // PWA & OFFLINE SUPPORT
        // =================================================================

        function setupPWA() {
            // Install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-prompt').classList.add('show');
            });

            // Service Worker registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(createServiceWorkerBlob())
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }
        }

        function createServiceWorkerBlob() {
            const swCode = `
                const CACHE_NAME = 'meshtastic-v1';
                const urlsToCache = ['/'];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('install-prompt').classList.remove('show');
                    }
                    deferredPrompt = null;
                });
            }
        }

        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                document.getElementById('offline-banner').classList.remove('show');
                addMessage('System', '‚úì Back online');
            });

            window.addEventListener('offline', () => {
                document.getElementById('offline-banner').classList.add('show');
                addMessage('System', '‚ö†Ô∏è Working offline');
            });
        }

        function loadCachedData() {
            try {
                const cached = localStorage.getItem('meshtastic_nodes');
                if (cached) {
                    const data = JSON.parse(cached);
                    data.forEach(node => addNode(node));
                    addMessage('System', `‚úì Loaded ${data.length} cached nodes`);
                }
            } catch (e) {
                console.error('Error loading cache:', e);
            }
        }

        function saveToCache() {
            try {
                const data = Array.from(nodes.values());
                localStorage.setItem('meshtastic_nodes', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving cache:', e);
            }
        }

        // =================================================================
        // BROWSER SUPPORT CHECKING
        // =================================================================

        function checkBrowserSupport() {
            // Check Web Bluetooth
            if ('bluetooth' in navigator) {
                document.getElementById('bluetooth-btn').classList.remove('disabled');
            }

            // Check Web Serial
            if ('serial' in navigator) {
                document.getElementById('serial-btn').classList.remove('disabled');
            }

            // WiFi is always available
            document.getElementById('wifi-btn').classList.remove('disabled');
        }

        // =================================================================
        // CONNECTION METHODS
        // =================================================================

        async function connectBluetooth() {
            if (!('bluetooth' in navigator)) {
                alert('Web Bluetooth is not supported in this browser. Try Chrome/Edge.');
                return;
            }

            try {
                addMessage('System', 'üîç Searching for Meshtastic devices via Bluetooth...');
                
                // Request Bluetooth device
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['6ba1b218-15a8-461f-9fa8-5dcae273eafd'] }, // Meshtastic service
                        { namePrefix: 'Meshtastic' }
                    ],
                    optionalServices: ['6ba1b218-15a8-461f-9fa8-5dcae273eafd']
                });

                addMessage('System', `‚úì Found device: ${bluetoothDevice.name}`);
                
                // Connect to GATT server
                const server = await bluetoothDevice.gatt.connect();
                addMessage('System', '‚úì Connected to GATT server');

                // Get service and characteristic
                const service = await server.getPrimaryService('6ba1b218-15a8-461f-9fa8-5dcae273eafd');
                const characteristic = await service.getCharacteristic('8ba2bcc2-ee02-4a55-a531-c525c5e454d5');

                // Start notifications
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);

                updateConnectionStatus('bluetooth', 'connected', bluetoothDevice.name);
                addMessage('System', '‚úÖ Bluetooth connection established');

                // Start discovery
                setTimeout(() => startDiscovery(), 1000);

            } catch (error) {
                console.error('Bluetooth error:', error);
                addMessage('System', `‚ùå Bluetooth error: ${error.message}`);
                updateConnectionStatus('bluetooth', 'error');
            }
        }

        function handleBluetoothData(event) {
            const value = event.target.value;
            const data = new Uint8Array(value.buffer);
            
            // Parse Meshtastic protobuf data here
            // This is a simplified example - actual implementation needs protobuf parsing
            console.log('Received BLE data:', data);
            
            // Simulate node discovery for demo
            if (nodes.size === 0) {
                setTimeout(() => {
                    addDemoNode('!ble001', 'BLE Node 1', 45.4981, -122.4404);
                    addDemoNode('!ble002', 'BLE Node 2', 45.5081, -122.4504);
                }, 2000);
            }
        }

        async function connectSerial() {
            if (!('serial' in navigator)) {
                alert('Web Serial is not supported in this browser. Try Chrome/Edge.');
                return;
            }

            try {
                addMessage('System', 'üîå Opening serial port...');
                
                // Request serial port
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 115200 });

                addMessage('System', '‚úì Serial port opened');
                updateConnectionStatus('serial', 'connected', 'USB Serial');

                // Read from serial port
                const reader = serialPort.readable.getReader();
                readSerialData(reader);

                addMessage('System', '‚úÖ Serial connection established');
                setTimeout(() => startDiscovery(), 1000);

            } catch (error) {
                console.error('Serial error:', error);
                addMessage('System', `‚ùå Serial error: ${error.message}`);
                updateConnectionStatus('serial', 'error');
            }
        }

        async function readSerialData(reader) {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // Parse Meshtastic data
                    console.log('Received serial data:', value);
                    
                    // Simulate node discovery for demo
                    if (nodes.size === 0) {
                        setTimeout(() => {
                            addDemoNode('!ser001', 'Serial Node 1', 45.4881, -122.4304);
                            addDemoNode('!ser002', 'Serial Node 2', 45.5181, -122.4604);
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Serial read error:', error);
            }
        }

        async function connectWiFi() {
            const ip = prompt('Enter Meshtastic device IP address:', '192.168.1.100');
            if (!ip) return;

            try {
                addMessage('System', `üì∂ Connecting to ${ip}...`);
                
                // Connect via WebSocket or HTTP
                wifiSocket = new WebSocket(`ws://${ip}:4403/api/v1/stream`);
                
                wifiSocket.onopen = () => {
                    addMessage('System', `‚úì Connected to ${ip}`);
                    updateConnectionStatus('wifi', 'connected', ip);
                    addMessage('System', '‚úÖ WiFi connection established');
                    setTimeout(() => startDiscovery(), 1000);
                };

                wifiSocket.onmessage = (event) => {
                    console.log('WiFi data:', event.data);
                    // Parse and handle data
                };

                wifiSocket.onerror = (error) => {
                    console.error('WiFi error:', error);
                    addMessage('System', '‚ùå WiFi connection failed');
                    updateConnectionStatus('wifi', 'error');
                };

                wifiSocket.onclose = () => {
                    addMessage('System', '‚ö†Ô∏è WiFi connection closed');
                    updateConnectionStatus('wifi', 'disconnected');
                };

                // Demo fallback
                setTimeout(() => {
                    if (nodes.size === 0) {
                        addDemoNode('!wifi01', 'WiFi Node 1', 45.4781, -122.4204);
                        addDemoNode('!wifi02', 'WiFi Node 2', 45.5281, -122.4704);
                        addDemoNode('!wifi03', 'WiFi Node 3', 45.4681, -122.4104);
                    }
                }, 3000);

            } catch (error) {
                console.error('WiFi error:', error);
                addMessage('System', `‚ùå WiFi error: ${error.message}`);
                updateConnectionStatus('wifi', 'error');
            }
        }

        function updateConnectionStatus(type, status, info = '') {
            connectionType = type;
            currentConnection = status;

            const dot = document.getElementById('connection-dot');
            const statusText = document.getElementById('connection-status');
            const details = document.getElementById('connection-details');
            const methodName = document.getElementById('connection-method-name');
            const connectionInfo = document.getElementById('connection-info');

            // Update status dot
            dot.className = 'status-dot';
            if (status === 'connected') {
                dot.classList.add('online');
                statusText.textContent = 'Connected';
            } else if (status === 'connecting') {
                dot.classList.add('connecting');
                statusText.textContent = 'Connecting...';
            } else {
                dot.classList.add('offline');
                statusText.textContent = 'Not Connected';
            }

            // Update connection details
            if (status === 'connected') {
                details.style.display = 'block';
                methodName.textContent = type.toUpperCase() + ' Connection';
                connectionInfo.textContent = info;

                // Highlight active button
                document.querySelectorAll('.connection-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`${type}-btn`).classList.add('active');
            }
        }

        // =================================================================
        // NODE DISCOVERY
        // =================================================================

        async function startDiscovery() {
            if (!currentConnection || currentConnection !== 'connected') {
                alert('Please connect to a device first');
                return;
            }

            const btn = document.getElementById('discover-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Discovering...';

            addMessage('System', 'üîç Starting network discovery...');

            // Actual discovery would query the device
            // For demo, simulate discovery
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = 'üîç Start Discovery';
                addMessage('System', `‚úÖ Discovery complete! Found ${nodes.size} nodes`);
            }, 5000);
        }

        function addDemoNode(id, name, lat, lon) {
            const node = {
                id: id,
                name: name,
                snr: (Math.random() * 15 - 5).toFixed(1),
                rssi: (Math.random() * -40 - 80).toFixed(0),
                hops: Math.floor(Math.random() * 3),
                battery: Math.floor(Math.random() * 40 + 60),
                position: { latitude: lat, longitude: lon },
                lastSeen: new Date(),
                packets: Math.floor(Math.random() * 50 + 10)
            };

            addNode(node);
            addMessage('System', `üéØ Discovered: ${name}`);
        }

        // =================================================================
        // MAP FUNCTIONALITY
        // =================================================================

        function initMap() {
            // Default center (Gresham, Oregon)
            map = L.map('map').setView([45.4981, -122.4404], 11);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Initial coverage circle
            L.circle([45.4981, -122.4404], {
                color: '#00d9ff',
                fillColor: '#00d9ff',
                fillOpacity: 0.1,
                radius: 5000
            }).addTo(map);
        }

        function addNodeToMap(node) {
            if (!node.position || !node.position.latitude || !node.position.longitude) return;

            const lat = node.position.latitude;
            const lon = node.position.longitude;

            // Remove existing marker
            if (markers[node.id]) {
                map.removeLayer(markers[node.id]);
            }

            // Create marker
            const icon = L.divIcon({
                className: 'custom-marker',
                html: 'üì°',
                iconSize: [30, 30]
            });

            const marker = L.marker([lat, lon], { icon: icon }).addTo(map);
            
            marker.bindPopup(`
                <div style="font-family: -apple-system, sans-serif; padding: 0.5rem; min-width: 150px;">
                    <strong style="color: #00d9ff;">${node.name}</strong><br>
                    <small style="color: #64748b;">${node.id}</small><br>
                    <br>
                    <strong>SNR:</strong> ${node.snr || 'N/A'} dB<br>
                    <strong>RSSI:</strong> ${node.rssi || 'N/A'} dBm<br>
                    <strong>Hops:</strong> ${node.hops || 0}<br>
                    <strong>Battery:</strong> ${node.battery || 'N/A'}%
                </div>
            `);

            markers[node.id] = marker;
            updateCoverage();
        }

        function updateCoverage() {
            const nodePositions = Array.from(nodes.values())
                .filter(n => n.position && n.position.latitude)
                .map(n => [n.position.latitude, n.position.longitude]);

            if (nodePositions.length > 0) {
                const bounds = L.latLngBounds(nodePositions);
                const center = bounds.getCenter();
                const radius = center.distanceTo(bounds.getNorthEast());
                
                document.getElementById('coverage-info').textContent = 
                    `${(radius / 1000).toFixed(2)} km radius ‚Ä¢ ${nodePositions.length} nodes`;
                document.getElementById('stat-range').textContent = 
                    `${(radius / 1000).toFixed(1)} km`;
            }
        }

        // =================================================================
        // NODE MANAGEMENT
        // =================================================================

        function addNode(nodeData) {
            const node = {
                id: nodeData.id,
                name: nodeData.name || nodeData.id,
                snr: nodeData.snr,
                rssi: nodeData.rssi,
                hops: nodeData.hops || 0,
                battery: nodeData.battery,
                position: nodeData.position,
                lastSeen: new Date(),
                packets: nodeData.packets || 1
            };

            nodes.set(node.id, node);
            updateNodeList();
            addNodeToMap(node);
            updateStats();
            saveToCache();
        }

        function updateNodeList() {
            const nodeList = document.getElementById('node-list');
            
            if (nodes.size === 0) {
                nodeList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-dim);">
                        Connect to a device and start discovery to find nodes
                    </div>
                `;
                return;
            }

            nodeList.innerHTML = Array.from(nodes.values())
                .sort((a, b) => b.lastSeen - a.lastSeen)
                .map(node => {
                    const snrClass = node.snr > 5 ? 'good' : node.snr > 0 ? 'warning' : 'bad';
                    const rssiClass = node.rssi > -90 ? 'good' : node.rssi > -110 ? 'warning' : 'bad';
                    
                    return `
                        <div class="node-item" onclick="focusNode('${node.id}')">
                            <div class="node-header">
                                <span class="node-name">${node.name}</span>
                                <span style="font-size: 0.75rem; color: var(--text-dim);">${node.id}</span>
                            </div>
                            <div class="node-metrics">
                                <div class="metric">
                                    <span class="metric-label">SNR</span>
                                    <span class="metric-value ${snrClass}">${node.snr || 'N/A'}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">RSSI</span>
                                    <span class="metric-value ${rssiClass}">${node.rssi || 'N/A'}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Hops</span>
                                    <span class="metric-value">${node.hops}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Battery</span>
                                    <span class="metric-value">${node.battery || '--'}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('node-count').textContent = nodes.size;
            document.getElementById('last-update').textContent = 
                `Updated ${new Date().toLocaleTimeString()}`;
        }

        function focusNode(nodeId) {
            const node = nodes.get(nodeId);
            if (node && node.position) {
                map.setView([node.position.latitude, node.position.longitude], 14);
                if (markers[nodeId]) {
                    markers[nodeId].openPopup();
                }
            }
        }

        function updateStats() {
            document.getElementById('stat-nodes').textContent = nodes.size;
            document.getElementById('stat-messages').textContent = messageCount;
            document.getElementById('message-count').textContent = messageCount;
            
            const avgSnr = Array.from(nodes.values())
                .filter(n => n.snr != null)
                .reduce((sum, n, _, arr) => sum + parseFloat(n.snr) / arr.length, 0);
            
            document.getElementById('stat-snr').textContent = 
                avgSnr ? avgSnr.toFixed(1) + ' dB' : '--';
        }

        // =================================================================
        // MESSAGING
        // =================================================================

        function addMessage(from, text) {
            messageCount++;
            const log = document.getElementById('message-log');
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `
                <div class="message-header">
                    <span>${from}</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-body">${text}</div>
            `;
            log.appendChild(message);
            log.scrollTop = log.scrollHeight;
            updateStats();
        }

        function clearMessages() {
            const log = document.getElementById('message-log');
            log.innerHTML = `
                <div class="message">
                    <div class="message-header">
                        <span>System</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-body">Message log cleared</div>
                </div>
            `;
            messageCount = 0;
            updateStats();
        }

        function openBroadcastModal() {
            if (!currentConnection || currentConnection !== 'connected') {
                alert('Please connect to a device first');
                return;
            }
            document.getElementById('broadcast-modal').classList.add('active');
        }

        function closeBroadcastModal() {
            document.getElementById('broadcast-modal').classList.remove('active');
        }

        function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value;
            const priority = document.getElementById('message-priority').value;
            
            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Send via active connection
            if (connectionType === 'bluetooth' && bluetoothDevice) {
                // Send via Bluetooth
                addMessage('You', `üì¢ [${priority}] ${message}`);
            } else if (connectionType === 'serial' && serialPort) {
                // Send via Serial
                addMessage('You', `üì¢ [${priority}] ${message}`);
            } else if (connectionType === 'wifi' && wifiSocket) {
                // Send via WiFi
                wifiSocket.send(JSON.stringify({ type: 'broadcast', message, priority }));
                addMessage('You', `üì¢ [${priority}] ${message}`);
            }

            closeBroadcastModal();
            document.getElementById('broadcast-message').value = '';
        }

        // =================================================================
        // DATA EXPORT
        // =================================================================

        function exportData() {
            const data = {
                exported: new Date().toISOString(),
                connectionType: connectionType,
                nodes: Array.from(nodes.values()),
                stats: {
                    totalNodes: nodes.size,
                    totalMessages: messageCount,
                    uptime: Date.now() - startTime
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meshtastic-export-${Date.now()}.json`;
            a.click();
            
            addMessage('System', 'üíæ Data exported successfully');
        }

        // Close modal on outside click
        document.getElementById('broadcast-modal').addEventListener('click', (e) => {
            if (e.target.id === 'broadcast-modal') {
                closeBroadcastModal();
            }
        });
    </script>
</body>
</html>
